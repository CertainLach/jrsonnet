name: Compare with Tanka

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  compare:
    name: Compare with Grafana Tanka
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rustanka
        uses: actions/checkout@v4.1.4
        with:
          path: rustanka

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1.8.0

      - name: Install Grafana Tanka
        run: |
          TK_VERSION=$(curl -s https://api.github.com/repos/grafana/tanka/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -fSL -o "/usr/local/bin/tk" "https://github.com/grafana/tanka/releases/latest/download/tk-linux-amd64"
          chmod +x /usr/local/bin/tk
          tk --version

      - name: Clone deployment_tools
        # Note: deployment_tools is a Grafana internal repository
        # This step will fail if you don't have access
        # You can replace this with your own test repository
        run: |
          git clone --depth=1 https://github.com/grafana/deployment_tools.git
        continue-on-error: true

      - name: Check if deployment_tools exists
        id: check_deployment_tools
        run: |
          if [ -d "deployment_tools" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "path=$(pwd)/deployment_tools" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run comparison
        if: steps.check_deployment_tools.outputs.exists == 'true'
        id: run_comparison
        working-directory: rustanka
        run: |
          set +e
          make tk-compare-grafana DEPLOYMENT_TOOLS_PATH=${{ steps.check_deployment_tools.outputs.path }} TK_PATH=/usr/local/bin/tk > ../comparison-output.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          cat ../comparison-output.txt
        continue-on-error: true

      - name: Prepare comment body
        if: steps.check_deployment_tools.outputs.exists == 'true'
        id: prepare_comment
        run: |
          if [ -f comparison-output.txt ]; then
            echo "comment<<EOF" >> $GITHUB_OUTPUT
            echo "## ðŸ”¬ Tanka Comparison Results" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "Comparing [Grafana Tanka](https://github.com/grafana/tanka) with rustanka:" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
            cat comparison-output.txt >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "comment=No comparison output available" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        if: steps.check_deployment_tools.outputs.exists == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `${{ steps.prepare_comment.outputs.comment }}`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ”¬ Tanka Comparison Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Post commit comment
        if: steps.check_deployment_tools.outputs.exists == 'true' && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `${{ steps.prepare_comment.outputs.comment }}`;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });

      - name: Skip comparison (no deployment_tools)
        if: steps.check_deployment_tools.outputs.exists == 'false'
        run: |
          echo "Skipping comparison: deployment_tools repository not accessible"
          echo "This is expected if you don't have access to Grafana's internal repositories"

      - name: Upload comparison output
        if: steps.check_deployment_tools.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tk-compare-output
          path: comparison-output.txt
          if-no-files-found: ignore

      - name: Upload workspace on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: tk-compare-workspace
          path: rustanka/.tk-compare-workspace/
          if-no-files-found: ignore

