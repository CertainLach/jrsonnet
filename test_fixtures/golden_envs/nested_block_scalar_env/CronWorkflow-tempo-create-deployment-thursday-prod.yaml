apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  labels:
    tanka.dev/environment: c8f617b25ed4f2c8204b79d8f9171dc0b6bee9b4f79a9ada
  name: tempo-create-deployment-thursday-prod
  namespace: tracing-cd
spec:
  schedule: 0 8 * * thu
  suspend: false
  workflowMetadata:
    labels:
      team: tempo
  workflowSpec:
    activeDeadlineSeconds: 172800
    entrypoint: main
    hooks:
      completion-message:
        arguments:
          parameters:
          - name: channel
            value: '#automated-rollouts'
          - name: color
            value: '#00ff00'
          - name: context
            value: ""
          - name: message
            value: ""
          - name: thread_send_also_to_channel
            value: "false"
          - name: thread_ts
            value: '{{workflow.outputs.parameters.thread_ts}}'
          - name: title
            value: ':done: Rollout completed'
        expression: workflow.status == "Succeeded"
        templateRef:
          clusterScope: true
          name: slack-notify
          template: slack-notify
    imagePullSecrets:
    - name: gar
    onExit: exit-handler
    podGC:
      strategy: OnWorkflowCompletion
    templateDefaults:
      serviceAccountName: argo-workflow
    templates:
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: failure-query-prod-region-4--tracing-prod-27-naive-check-weekly-release-number-failure
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: failure_query
              value: tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-4", namespace="tracing-prod-27"}
            - name: initial_delay
              value: 10m
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-4.tracing-prod-27 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-4", namespace="tracing-prod-27"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number-failure` failed
                    for `prod-region-4.tracing-prod-27`
              expression: steps["query-gate-prod-region-4--tracing-prod-27-naive-check-weekly-release-number-failure"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number-failure`
                    passed for `prod-region-4.tracing-prod-27`'
              expression: steps["query-gate-prod-region-4--tracing-prod-27-naive-check-weekly-release-number-failure"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-4--tracing-prod-27-naive-check-weekly-release-number-failure
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: failure-query-prod-region-5--tracing-cell-03-naive-check-weekly-release-number-failure
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: failure_query
              value: tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-5", namespace="tracing-cell-03"}
            - name: initial_delay
              value: 10m
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-5.tracing-cell-03 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-5", namespace="tracing-cell-03"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number-failure` failed
                    for `prod-region-5.tracing-cell-03`
              expression: steps["query-gate-prod-region-5--tracing-cell-03-naive-check-weekly-release-number-failure"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number-failure`
                    passed for `prod-region-5.tracing-cell-03`'
              expression: steps["query-gate-prod-region-5--tracing-cell-03-naive-check-weekly-release-number-failure"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-5--tracing-cell-03-naive-check-weekly-release-number-failure
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: failure-query-prod-region-2--tracing-cell-05-naive-check-weekly-release-number-failure
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: failure_query
              value: tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-2", namespace="tracing-cell-05"}
            - name: initial_delay
              value: 10m
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-2.tracing-cell-05 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tracing-cell-05"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number-failure` failed
                    for `prod-region-2.tracing-cell-05`
              expression: steps["query-gate-prod-region-2--tracing-cell-05-naive-check-weekly-release-number-failure"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number-failure`
                    passed for `prod-region-2.tracing-cell-05`'
              expression: steps["query-gate-prod-region-2--tracing-cell-05-naive-check-weekly-release-number-failure"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-2--tracing-cell-05-naive-check-weekly-release-number-failure
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: failure-query-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number-failure
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: failure_query
              value: tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-2", namespace="tempo-hsla-01"}
            - name: initial_delay
              value: 10m
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-2.tempo-hsla-01 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tempo-hsla-01"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number-failure` failed
                    for `prod-region-2.tempo-hsla-01`
              expression: steps["query-gate-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number-failure"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number-failure`
                    passed for `prod-region-2.tempo-hsla-01`'
              expression: steps["query-gate-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number-failure"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number-failure
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: failure-query-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number-failure
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: failure_query
              value: tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-eu-west-5", namespace="tempo-dedicated-08"}
            - name: initial_delay
              value: 10m
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-eu-west-5.tempo-dedicated-08 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-eu-west-5", namespace="tempo-dedicated-08"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number-failure` failed
                    for `prod-eu-west-5.tempo-dedicated-08`
              expression: steps["query-gate-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number-failure"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number-failure`
                    passed for `prod-eu-west-5.tempo-dedicated-08`'
              expression: steps["query-gate-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number-failure"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number-failure
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: failure-query-prod-region-1--tracing-cell-06-naive-check-weekly-release-number-failure
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: failure_query
              value: tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-1", namespace="tracing-cell-06"}
            - name: initial_delay
              value: 10m
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-1.tracing-cell-06 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-1", namespace="tracing-cell-06"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number-failure` failed
                    for `prod-region-1.tracing-cell-06`
              expression: steps["query-gate-prod-region-1--tracing-cell-06-naive-check-weekly-release-number-failure"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number-failure`
                    passed for `prod-region-1.tracing-cell-06`'
              expression: steps["query-gate-prod-region-1--tracing-cell-06-naive-check-weekly-release-number-failure"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-1--tracing-cell-06-naive-check-weekly-release-number-failure
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: failure-query-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number-failure
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: failure_query
              value: tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-3", namespace="tempo-dedicated-01"}
            - name: initial_delay
              value: 10m
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-3.tempo-dedicated-01 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-3", namespace="tempo-dedicated-01"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number-failure` failed
                    for `prod-region-3.tempo-dedicated-01`
              expression: steps["query-gate-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number-failure"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number-failure`
                    passed for `prod-region-3.tempo-dedicated-01`'
              expression: steps["query-gate-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number-failure"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number-failure
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: failure-query-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number-failure
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: failure_query
              value: tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-6", namespace="tempo-dedicated-04"}
            - name: initial_delay
              value: 10m
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-6.tempo-dedicated-04 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version!~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-6", namespace="tempo-dedicated-04"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number-failure` failed
                    for `prod-region-6.tempo-dedicated-04`
              expression: steps["query-gate-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number-failure"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number-failure`
                    passed for `prod-region-6.tempo-dedicated-04`'
              expression: steps["query-gate-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number-failure"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number-failure
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: healthchecks-prod-region-4--tracing-prod-27
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-4--tracing-prod-27-naive-check-weekly-release-number
          template: success-query-prod-region-4--tracing-prod-27-naive-check-weekly-release-number
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-4--tracing-prod-27-tempo-rollout-health-check
          template: success-query-prod-region-4--tracing-prod-27-tempo-rollout-health-check
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-failure-query-prod-region-4--tracing-prod-27-naive-check-weekly-release-number-failure
          template: failure-query-prod-region-4--tracing-prod-27-naive-check-weekly-release-number-failure
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: healthchecks-prod-region-5--tracing-cell-03
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-5--tracing-cell-03-naive-check-weekly-release-number
          template: success-query-prod-region-5--tracing-cell-03-naive-check-weekly-release-number
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-5--tracing-cell-03-tempo-rollout-health-check
          template: success-query-prod-region-5--tracing-cell-03-tempo-rollout-health-check
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-failure-query-prod-region-5--tracing-cell-03-naive-check-weekly-release-number-failure
          template: failure-query-prod-region-5--tracing-cell-03-naive-check-weekly-release-number-failure
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: healthchecks-prod-region-2--tracing-cell-05
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-2--tracing-cell-05-naive-check-weekly-release-number
          template: success-query-prod-region-2--tracing-cell-05-naive-check-weekly-release-number
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-2--tracing-cell-05-tempo-rollout-health-check
          template: success-query-prod-region-2--tracing-cell-05-tempo-rollout-health-check
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-failure-query-prod-region-2--tracing-cell-05-naive-check-weekly-release-number-failure
          template: failure-query-prod-region-2--tracing-cell-05-naive-check-weekly-release-number-failure
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: healthchecks-prod-region-2--tempo-hsla-01
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number
          template: success-query-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-2--tempo-hsla-01-tempo-rollout-health-check
          template: success-query-prod-region-2--tempo-hsla-01-tempo-rollout-health-check
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-failure-query-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number-failure
          template: failure-query-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number-failure
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: healthchecks-prod-eu-west-5--tempo-dedicated-08
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number
          template: success-query-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-eu-west-5--tempo-dedicated-08-tempo-rollout-health-check
          template: success-query-prod-eu-west-5--tempo-dedicated-08-tempo-rollout-health-check
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-failure-query-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number-failure
          template: failure-query-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number-failure
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: healthchecks-prod-region-1--tracing-cell-06
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-1--tracing-cell-06-naive-check-weekly-release-number
          template: success-query-prod-region-1--tracing-cell-06-naive-check-weekly-release-number
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-1--tracing-cell-06-tempo-rollout-health-check
          template: success-query-prod-region-1--tracing-cell-06-tempo-rollout-health-check
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-failure-query-prod-region-1--tracing-cell-06-naive-check-weekly-release-number-failure
          template: failure-query-prod-region-1--tracing-cell-06-naive-check-weekly-release-number-failure
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: healthchecks-prod-region-3--tempo-dedicated-01
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number
          template: success-query-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-3--tempo-dedicated-01-tempo-rollout-health-check
          template: success-query-prod-region-3--tempo-dedicated-01-tempo-rollout-health-check
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-failure-query-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number-failure
          template: failure-query-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number-failure
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: healthchecks-prod-region-6--tempo-dedicated-04
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number
          template: success-query-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-success-query-prod-region-6--tempo-dedicated-04-tempo-rollout-health-check
          template: success-query-prod-region-6--tempo-dedicated-04-tempo-rollout-health-check
        - arguments:
            parameters:
            - name: mergedAt
              value: '{{inputs.parameters.mergedAt}}'
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          name: query-metrics-failure-query-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number-failure
          template: failure-query-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number-failure
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: release-prod-region-4--tracing-prod-27
      outputs:
        parameters:
        - name: mergedAt
          valueFrom:
            expression: 'steps["create-deployment-prs-prod-region-4--tracing-prod-27-wait-for-pr"].status
              == "Succeeded" ? jsonpath(steps["create-deployment-prs-prod-region-4--tracing-prod-27-wait-for-pr"].outputs.parameters["commit-info"],
              "$.mergedAt") : string(sprig.now().Unix())'
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: auto-merge
              value: true
            - name: cell
              value: prod-region-4.tracing-prod-27
            - name: dry-run
              value: false
            - name: release
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: verbose
              value: true
          hooks:
            pr-created:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    RT created the following PR(s):

                    ```
                    {{= toJson(jsonpath(steps["create-deployment-prs-prod-region-4--tracing-prod-27"].outputs.parameters.info, "$.PullRequests")) }}
                    ```
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-opened: PR created for cell `prod-region-4.tracing-prod-27`'
              expression: steps["create-deployment-prs-prod-region-4--tracing-prod-27"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-4--tracing-prod-27
          templateRef:
            clusterScope: true
            name: rt-release-rollout-cell
            template: rt-release-rollout-cell
      - - arguments:
            parameters:
            - name: pr_url
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-4--tracing-prod-27"].outputs.parameters.info,
                "$.PullRequests[0].Url")}}'
            - name: timeout
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-4--tracing-prod-27"].outputs.parameters.info,
                "$.PullRequests[0].Timeout")}}'
          hooks:
            notify-if-draft:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ffff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team RT created the following PR as a draft: {{=jsonpath(steps["create-deployment-prs-prod-region-4--tracing-prod-27"].outputs.parameters.info, "$.PullRequests[0].Url")}}
                    Please review and approve manually.
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: PR created as draft
              expression: '{{=jsonpath(steps["create-deployment-prs-prod-region-4--tracing-prod-27"].outputs.parameters.info,
                "$.PullRequests[0].Draft")}}'
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            pr-merged:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: 'The following PR has been merged: {{=jsonpath(steps["create-deployment-prs-prod-region-4--tracing-prod-27"].outputs.parameters.info,
                    "$.PullRequests[0].Url")}}'
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-merged: PR has been merged'
              expression: steps["create-deployment-prs-prod-region-4--tracing-prod-27-wait-for-pr"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-4--tracing-prod-27-wait-for-pr
          templateRef:
            clusterScope: true
            name: wait-for-github-pr
            template: wait-for-github-pr
          when: '{{=jsonpath(steps["create-deployment-prs-prod-region-4--tracing-prod-27"].outputs.parameters.info,
            "$.PullRequests")}} != []'
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: release-prod-region-5--tracing-cell-03
      outputs:
        parameters:
        - name: mergedAt
          valueFrom:
            expression: 'steps["create-deployment-prs-prod-region-5--tracing-cell-03-wait-for-pr"].status
              == "Succeeded" ? jsonpath(steps["create-deployment-prs-prod-region-5--tracing-cell-03-wait-for-pr"].outputs.parameters["commit-info"],
              "$.mergedAt") : string(sprig.now().Unix())'
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: auto-merge
              value: true
            - name: cell
              value: prod-region-5.tracing-cell-03
            - name: dry-run
              value: false
            - name: release
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: verbose
              value: true
          hooks:
            pr-created:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    RT created the following PR(s):

                    ```
                    {{= toJson(jsonpath(steps["create-deployment-prs-prod-region-5--tracing-cell-03"].outputs.parameters.info, "$.PullRequests")) }}
                    ```
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-opened: PR created for cell `prod-region-5.tracing-cell-03`'
              expression: steps["create-deployment-prs-prod-region-5--tracing-cell-03"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-5--tracing-cell-03
          templateRef:
            clusterScope: true
            name: rt-release-rollout-cell
            template: rt-release-rollout-cell
      - - arguments:
            parameters:
            - name: pr_url
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-5--tracing-cell-03"].outputs.parameters.info,
                "$.PullRequests[0].Url")}}'
            - name: timeout
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-5--tracing-cell-03"].outputs.parameters.info,
                "$.PullRequests[0].Timeout")}}'
          hooks:
            notify-if-draft:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ffff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team RT created the following PR as a draft: {{=jsonpath(steps["create-deployment-prs-prod-region-5--tracing-cell-03"].outputs.parameters.info, "$.PullRequests[0].Url")}}
                    Please review and approve manually.
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: PR created as draft
              expression: '{{=jsonpath(steps["create-deployment-prs-prod-region-5--tracing-cell-03"].outputs.parameters.info,
                "$.PullRequests[0].Draft")}}'
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            pr-merged:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: 'The following PR has been merged: {{=jsonpath(steps["create-deployment-prs-prod-region-5--tracing-cell-03"].outputs.parameters.info,
                    "$.PullRequests[0].Url")}}'
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-merged: PR has been merged'
              expression: steps["create-deployment-prs-prod-region-5--tracing-cell-03-wait-for-pr"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-5--tracing-cell-03-wait-for-pr
          templateRef:
            clusterScope: true
            name: wait-for-github-pr
            template: wait-for-github-pr
          when: '{{=jsonpath(steps["create-deployment-prs-prod-region-5--tracing-cell-03"].outputs.parameters.info,
            "$.PullRequests")}} != []'
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: release-prod-region-2--tracing-cell-05
      outputs:
        parameters:
        - name: mergedAt
          valueFrom:
            expression: 'steps["create-deployment-prs-prod-region-2--tracing-cell-05-wait-for-pr"].status
              == "Succeeded" ? jsonpath(steps["create-deployment-prs-prod-region-2--tracing-cell-05-wait-for-pr"].outputs.parameters["commit-info"],
              "$.mergedAt") : string(sprig.now().Unix())'
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: auto-merge
              value: true
            - name: cell
              value: prod-region-2.tracing-cell-05
            - name: dry-run
              value: false
            - name: release
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: verbose
              value: true
          hooks:
            pr-created:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    RT created the following PR(s):

                    ```
                    {{= toJson(jsonpath(steps["create-deployment-prs-prod-region-2--tracing-cell-05"].outputs.parameters.info, "$.PullRequests")) }}
                    ```
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-opened: PR created for cell `prod-region-2.tracing-cell-05`'
              expression: steps["create-deployment-prs-prod-region-2--tracing-cell-05"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-2--tracing-cell-05
          templateRef:
            clusterScope: true
            name: rt-release-rollout-cell
            template: rt-release-rollout-cell
      - - arguments:
            parameters:
            - name: pr_url
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-2--tracing-cell-05"].outputs.parameters.info,
                "$.PullRequests[0].Url")}}'
            - name: timeout
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-2--tracing-cell-05"].outputs.parameters.info,
                "$.PullRequests[0].Timeout")}}'
          hooks:
            notify-if-draft:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ffff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team RT created the following PR as a draft: {{=jsonpath(steps["create-deployment-prs-prod-region-2--tracing-cell-05"].outputs.parameters.info, "$.PullRequests[0].Url")}}
                    Please review and approve manually.
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: PR created as draft
              expression: '{{=jsonpath(steps["create-deployment-prs-prod-region-2--tracing-cell-05"].outputs.parameters.info,
                "$.PullRequests[0].Draft")}}'
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            pr-merged:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: 'The following PR has been merged: {{=jsonpath(steps["create-deployment-prs-prod-region-2--tracing-cell-05"].outputs.parameters.info,
                    "$.PullRequests[0].Url")}}'
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-merged: PR has been merged'
              expression: steps["create-deployment-prs-prod-region-2--tracing-cell-05-wait-for-pr"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-2--tracing-cell-05-wait-for-pr
          templateRef:
            clusterScope: true
            name: wait-for-github-pr
            template: wait-for-github-pr
          when: '{{=jsonpath(steps["create-deployment-prs-prod-region-2--tracing-cell-05"].outputs.parameters.info,
            "$.PullRequests")}} != []'
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: release-prod-region-2--tempo-hsla-01
      outputs:
        parameters:
        - name: mergedAt
          valueFrom:
            expression: 'steps["create-deployment-prs-prod-region-2--tempo-hsla-01-wait-for-pr"].status
              == "Succeeded" ? jsonpath(steps["create-deployment-prs-prod-region-2--tempo-hsla-01-wait-for-pr"].outputs.parameters["commit-info"],
              "$.mergedAt") : string(sprig.now().Unix())'
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: auto-merge
              value: true
            - name: cell
              value: prod-region-2.tempo-hsla-01
            - name: dry-run
              value: false
            - name: release
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: verbose
              value: true
          hooks:
            pr-created:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    RT created the following PR(s):

                    ```
                    {{= toJson(jsonpath(steps["create-deployment-prs-prod-region-2--tempo-hsla-01"].outputs.parameters.info, "$.PullRequests")) }}
                    ```
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-opened: PR created for cell `prod-region-2.tempo-hsla-01`'
              expression: steps["create-deployment-prs-prod-region-2--tempo-hsla-01"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-2--tempo-hsla-01
          templateRef:
            clusterScope: true
            name: rt-release-rollout-cell
            template: rt-release-rollout-cell
      - - arguments:
            parameters:
            - name: pr_url
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-2--tempo-hsla-01"].outputs.parameters.info,
                "$.PullRequests[0].Url")}}'
            - name: timeout
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-2--tempo-hsla-01"].outputs.parameters.info,
                "$.PullRequests[0].Timeout")}}'
          hooks:
            notify-if-draft:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ffff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team RT created the following PR as a draft: {{=jsonpath(steps["create-deployment-prs-prod-region-2--tempo-hsla-01"].outputs.parameters.info, "$.PullRequests[0].Url")}}
                    Please review and approve manually.
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: PR created as draft
              expression: '{{=jsonpath(steps["create-deployment-prs-prod-region-2--tempo-hsla-01"].outputs.parameters.info,
                "$.PullRequests[0].Draft")}}'
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            pr-merged:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: 'The following PR has been merged: {{=jsonpath(steps["create-deployment-prs-prod-region-2--tempo-hsla-01"].outputs.parameters.info,
                    "$.PullRequests[0].Url")}}'
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-merged: PR has been merged'
              expression: steps["create-deployment-prs-prod-region-2--tempo-hsla-01-wait-for-pr"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-2--tempo-hsla-01-wait-for-pr
          templateRef:
            clusterScope: true
            name: wait-for-github-pr
            template: wait-for-github-pr
          when: '{{=jsonpath(steps["create-deployment-prs-prod-region-2--tempo-hsla-01"].outputs.parameters.info,
            "$.PullRequests")}} != []'
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: release-prod-eu-west-5--tempo-dedicated-08
      outputs:
        parameters:
        - name: mergedAt
          valueFrom:
            expression: 'steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08-wait-for-pr"].status
              == "Succeeded" ? jsonpath(steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08-wait-for-pr"].outputs.parameters["commit-info"],
              "$.mergedAt") : string(sprig.now().Unix())'
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: auto-merge
              value: true
            - name: cell
              value: prod-eu-west-5.tempo-dedicated-08
            - name: dry-run
              value: false
            - name: release
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: verbose
              value: true
          hooks:
            pr-created:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    RT created the following PR(s):

                    ```
                    {{= toJson(jsonpath(steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08"].outputs.parameters.info, "$.PullRequests")) }}
                    ```
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-opened: PR created for cell `prod-eu-west-5.tempo-dedicated-08`'
              expression: steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-eu-west-5--tempo-dedicated-08
          templateRef:
            clusterScope: true
            name: rt-release-rollout-cell
            template: rt-release-rollout-cell
      - - arguments:
            parameters:
            - name: pr_url
              value: '{{=jsonpath(steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08"].outputs.parameters.info,
                "$.PullRequests[0].Url")}}'
            - name: timeout
              value: '{{=jsonpath(steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08"].outputs.parameters.info,
                "$.PullRequests[0].Timeout")}}'
          hooks:
            notify-if-draft:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ffff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team RT created the following PR as a draft: {{=jsonpath(steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08"].outputs.parameters.info, "$.PullRequests[0].Url")}}
                    Please review and approve manually.
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: PR created as draft
              expression: '{{=jsonpath(steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08"].outputs.parameters.info,
                "$.PullRequests[0].Draft")}}'
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            pr-merged:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: 'The following PR has been merged: {{=jsonpath(steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08"].outputs.parameters.info,
                    "$.PullRequests[0].Url")}}'
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-merged: PR has been merged'
              expression: steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08-wait-for-pr"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-eu-west-5--tempo-dedicated-08-wait-for-pr
          templateRef:
            clusterScope: true
            name: wait-for-github-pr
            template: wait-for-github-pr
          when: '{{=jsonpath(steps["create-deployment-prs-prod-eu-west-5--tempo-dedicated-08"].outputs.parameters.info,
            "$.PullRequests")}} != []'
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: release-prod-region-1--tracing-cell-06
      outputs:
        parameters:
        - name: mergedAt
          valueFrom:
            expression: 'steps["create-deployment-prs-prod-region-1--tracing-cell-06-wait-for-pr"].status
              == "Succeeded" ? jsonpath(steps["create-deployment-prs-prod-region-1--tracing-cell-06-wait-for-pr"].outputs.parameters["commit-info"],
              "$.mergedAt") : string(sprig.now().Unix())'
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: auto-merge
              value: true
            - name: cell
              value: prod-region-1.tracing-cell-06
            - name: dry-run
              value: false
            - name: release
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: verbose
              value: true
          hooks:
            pr-created:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    RT created the following PR(s):

                    ```
                    {{= toJson(jsonpath(steps["create-deployment-prs-prod-region-1--tracing-cell-06"].outputs.parameters.info, "$.PullRequests")) }}
                    ```
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-opened: PR created for cell `prod-region-1.tracing-cell-06`'
              expression: steps["create-deployment-prs-prod-region-1--tracing-cell-06"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-1--tracing-cell-06
          templateRef:
            clusterScope: true
            name: rt-release-rollout-cell
            template: rt-release-rollout-cell
      - - arguments:
            parameters:
            - name: pr_url
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-1--tracing-cell-06"].outputs.parameters.info,
                "$.PullRequests[0].Url")}}'
            - name: timeout
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-1--tracing-cell-06"].outputs.parameters.info,
                "$.PullRequests[0].Timeout")}}'
          hooks:
            notify-if-draft:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ffff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team RT created the following PR as a draft: {{=jsonpath(steps["create-deployment-prs-prod-region-1--tracing-cell-06"].outputs.parameters.info, "$.PullRequests[0].Url")}}
                    Please review and approve manually.
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: PR created as draft
              expression: '{{=jsonpath(steps["create-deployment-prs-prod-region-1--tracing-cell-06"].outputs.parameters.info,
                "$.PullRequests[0].Draft")}}'
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            pr-merged:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: 'The following PR has been merged: {{=jsonpath(steps["create-deployment-prs-prod-region-1--tracing-cell-06"].outputs.parameters.info,
                    "$.PullRequests[0].Url")}}'
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-merged: PR has been merged'
              expression: steps["create-deployment-prs-prod-region-1--tracing-cell-06-wait-for-pr"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-1--tracing-cell-06-wait-for-pr
          templateRef:
            clusterScope: true
            name: wait-for-github-pr
            template: wait-for-github-pr
          when: '{{=jsonpath(steps["create-deployment-prs-prod-region-1--tracing-cell-06"].outputs.parameters.info,
            "$.PullRequests")}} != []'
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: release-prod-region-3--tempo-dedicated-01
      outputs:
        parameters:
        - name: mergedAt
          valueFrom:
            expression: 'steps["create-deployment-prs-prod-region-3--tempo-dedicated-01-wait-for-pr"].status
              == "Succeeded" ? jsonpath(steps["create-deployment-prs-prod-region-3--tempo-dedicated-01-wait-for-pr"].outputs.parameters["commit-info"],
              "$.mergedAt") : string(sprig.now().Unix())'
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: auto-merge
              value: true
            - name: cell
              value: prod-region-3.tempo-dedicated-01
            - name: dry-run
              value: false
            - name: release
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: verbose
              value: true
          hooks:
            pr-created:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    RT created the following PR(s):

                    ```
                    {{= toJson(jsonpath(steps["create-deployment-prs-prod-region-3--tempo-dedicated-01"].outputs.parameters.info, "$.PullRequests")) }}
                    ```
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-opened: PR created for cell `prod-region-3.tempo-dedicated-01`'
              expression: steps["create-deployment-prs-prod-region-3--tempo-dedicated-01"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-3--tempo-dedicated-01
          templateRef:
            clusterScope: true
            name: rt-release-rollout-cell
            template: rt-release-rollout-cell
      - - arguments:
            parameters:
            - name: pr_url
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-3--tempo-dedicated-01"].outputs.parameters.info,
                "$.PullRequests[0].Url")}}'
            - name: timeout
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-3--tempo-dedicated-01"].outputs.parameters.info,
                "$.PullRequests[0].Timeout")}}'
          hooks:
            notify-if-draft:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ffff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team RT created the following PR as a draft: {{=jsonpath(steps["create-deployment-prs-prod-region-3--tempo-dedicated-01"].outputs.parameters.info, "$.PullRequests[0].Url")}}
                    Please review and approve manually.
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: PR created as draft
              expression: '{{=jsonpath(steps["create-deployment-prs-prod-region-3--tempo-dedicated-01"].outputs.parameters.info,
                "$.PullRequests[0].Draft")}}'
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            pr-merged:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: 'The following PR has been merged: {{=jsonpath(steps["create-deployment-prs-prod-region-3--tempo-dedicated-01"].outputs.parameters.info,
                    "$.PullRequests[0].Url")}}'
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-merged: PR has been merged'
              expression: steps["create-deployment-prs-prod-region-3--tempo-dedicated-01-wait-for-pr"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-3--tempo-dedicated-01-wait-for-pr
          templateRef:
            clusterScope: true
            name: wait-for-github-pr
            template: wait-for-github-pr
          when: '{{=jsonpath(steps["create-deployment-prs-prod-region-3--tempo-dedicated-01"].outputs.parameters.info,
            "$.PullRequests")}} != []'
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: release-prod-region-6--tempo-dedicated-04
      outputs:
        parameters:
        - name: mergedAt
          valueFrom:
            expression: 'steps["create-deployment-prs-prod-region-6--tempo-dedicated-04-wait-for-pr"].status
              == "Succeeded" ? jsonpath(steps["create-deployment-prs-prod-region-6--tempo-dedicated-04-wait-for-pr"].outputs.parameters["commit-info"],
              "$.mergedAt") : string(sprig.now().Unix())'
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: auto-merge
              value: true
            - name: cell
              value: prod-region-6.tempo-dedicated-04
            - name: dry-run
              value: false
            - name: release
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: verbose
              value: true
          hooks:
            pr-created:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    RT created the following PR(s):

                    ```
                    {{= toJson(jsonpath(steps["create-deployment-prs-prod-region-6--tempo-dedicated-04"].outputs.parameters.info, "$.PullRequests")) }}
                    ```
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-opened: PR created for cell `prod-region-6.tempo-dedicated-04`'
              expression: steps["create-deployment-prs-prod-region-6--tempo-dedicated-04"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-6--tempo-dedicated-04
          templateRef:
            clusterScope: true
            name: rt-release-rollout-cell
            template: rt-release-rollout-cell
      - - arguments:
            parameters:
            - name: pr_url
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-6--tempo-dedicated-04"].outputs.parameters.info,
                "$.PullRequests[0].Url")}}'
            - name: timeout
              value: '{{=jsonpath(steps["create-deployment-prs-prod-region-6--tempo-dedicated-04"].outputs.parameters.info,
                "$.PullRequests[0].Timeout")}}'
          hooks:
            notify-if-draft:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ffff00'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team RT created the following PR as a draft: {{=jsonpath(steps["create-deployment-prs-prod-region-6--tempo-dedicated-04"].outputs.parameters.info, "$.PullRequests[0].Url")}}
                    Please review and approve manually.
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: PR created as draft
              expression: '{{=jsonpath(steps["create-deployment-prs-prod-region-6--tempo-dedicated-04"].outputs.parameters.info,
                "$.PullRequests[0].Draft")}}'
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            pr-merged:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: 'The following PR has been merged: {{=jsonpath(steps["create-deployment-prs-prod-region-6--tempo-dedicated-04"].outputs.parameters.info,
                    "$.PullRequests[0].Url")}}'
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':pr-merged: PR has been merged'
              expression: steps["create-deployment-prs-prod-region-6--tempo-dedicated-04-wait-for-pr"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: create-deployment-prs-prod-region-6--tempo-dedicated-04-wait-for-pr
          templateRef:
            clusterScope: true
            name: wait-for-github-pr
            template: wait-for-github-pr
          when: '{{=jsonpath(steps["create-deployment-prs-prod-region-6--tempo-dedicated-04"].outputs.parameters.info,
            "$.PullRequests")}} != []'
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-4--tracing-prod-27-naive-check-weekly-release-number
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-4", namespace="tracing-prod-27"}
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-4.tracing-prod-27 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-4", namespace="tracing-prod-27"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number` failed for `prod-region-4.tracing-prod-27`
              expression: steps["query-gate-prod-region-4--tracing-prod-27-naive-check-weekly-release-number"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number` passed
                    for `prod-region-4.tracing-prod-27`'
              expression: steps["query-gate-prod-region-4--tracing-prod-27-naive-check-weekly-release-number"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-4--tracing-prod-27-naive-check-weekly-release-number
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-4--tracing-prod-27-tempo-rollout-health-check
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: |
                (
                    # All services have been updated to the expected version
                    sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-4", namespace="tracing-prod-27"})
                    ==
                    sum(tempo_build_info{cluster="prod-region-4", namespace="tracing-prod-27"})
                )
                and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                (
                    # Adaptive Traces either hasn't been deployed
                    absent(sampler_build_info{cluster="prod-region-4", namespace="tracing-prod-27"})
                    or
                    # or sampler and sampler-gateway have been updated to the expected version
                    (
                        sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-4", namespace="tracing-prod-27"})
                        ==
                        sum(sampler_build_info{cluster="prod-region-4", namespace="tracing-prod-27"})
                    )
                )
                and
                (
                    # All Deployment rollouts finished
                    sum(kube_deployment_status_replicas_updated{cluster="prod-region-4", namespace="tracing-prod-27"})
                    ==
                    sum(kube_deployment_spec_replicas{cluster="prod-region-4", namespace="tracing-prod-27"})
                )
                and
                (
                    # All StatefulSet rollouts finished
                    sum(kube_statefulset_status_replicas_updated{cluster="prod-region-4", namespace="tracing-prod-27"})
                    ==
                    sum(kube_statefulset_replicas{cluster="prod-region-4", namespace="tracing-prod-27"})
                )
                and
                (
                    # No unhealthy replicas in any Deployment
                    sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-4", namespace="tracing-prod-27"})
                    == 0
                )
                and
                (
                    # No unhealthy replicas in any StatefulSet
                    sum(kube_statefulset_status_replicas_current{cluster="prod-region-4", namespace="tracing-prod-27"})
                    ==
                    sum(kube_statefulset_status_replicas_ready {cluster="prod-region-4", namespace="tracing-prod-27"})
                )
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-4.tracing-prod-27 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    (
                        # All services have been updated to the expected version
                        sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-4", namespace="tracing-prod-27"})
                        ==
                        sum(tempo_build_info{cluster="prod-region-4", namespace="tracing-prod-27"})
                    )
                    and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                    (
                        # Adaptive Traces either hasn't been deployed
                        absent(sampler_build_info{cluster="prod-region-4", namespace="tracing-prod-27"})
                        or
                        # or sampler and sampler-gateway have been updated to the expected version
                        (
                            sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-4", namespace="tracing-prod-27"})
                            ==
                            sum(sampler_build_info{cluster="prod-region-4", namespace="tracing-prod-27"})
                        )
                    )
                    and
                    (
                        # All Deployment rollouts finished
                        sum(kube_deployment_status_replicas_updated{cluster="prod-region-4", namespace="tracing-prod-27"})
                        ==
                        sum(kube_deployment_spec_replicas{cluster="prod-region-4", namespace="tracing-prod-27"})
                    )
                    and
                    (
                        # All StatefulSet rollouts finished
                        sum(kube_statefulset_status_replicas_updated{cluster="prod-region-4", namespace="tracing-prod-27"})
                        ==
                        sum(kube_statefulset_replicas{cluster="prod-region-4", namespace="tracing-prod-27"})
                    )
                    and
                    (
                        # No unhealthy replicas in any Deployment
                        sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-4", namespace="tracing-prod-27"})
                        == 0
                    )
                    and
                    (
                        # No unhealthy replicas in any StatefulSet
                        sum(kube_statefulset_status_replicas_current{cluster="prod-region-4", namespace="tracing-prod-27"})
                        ==
                        sum(kube_statefulset_status_replicas_ready {cluster="prod-region-4", namespace="tracing-prod-27"})
                    )

                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `tempo-rollout-health-check` failed for `prod-region-4.tracing-prod-27`
              expression: steps["query-gate-prod-region-4--tracing-prod-27-tempo-rollout-health-check"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `tempo-rollout-health-check` passed for
                    `prod-region-4.tracing-prod-27`'
              expression: steps["query-gate-prod-region-4--tracing-prod-27-tempo-rollout-health-check"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-4--tracing-prod-27-tempo-rollout-health-check
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-5--tracing-cell-03-naive-check-weekly-release-number
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-5", namespace="tracing-cell-03"}
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-5.tracing-cell-03 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-5", namespace="tracing-cell-03"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number` failed for `prod-region-5.tracing-cell-03`
              expression: steps["query-gate-prod-region-5--tracing-cell-03-naive-check-weekly-release-number"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number` passed
                    for `prod-region-5.tracing-cell-03`'
              expression: steps["query-gate-prod-region-5--tracing-cell-03-naive-check-weekly-release-number"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-5--tracing-cell-03-naive-check-weekly-release-number
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-5--tracing-cell-03-tempo-rollout-health-check
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: |
                (
                    # All services have been updated to the expected version
                    sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-5", namespace="tracing-cell-03"})
                    ==
                    sum(tempo_build_info{cluster="prod-region-5", namespace="tracing-cell-03"})
                )
                and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                (
                    # Adaptive Traces either hasn't been deployed
                    absent(sampler_build_info{cluster="prod-region-5", namespace="tracing-cell-03"})
                    or
                    # or sampler and sampler-gateway have been updated to the expected version
                    (
                        sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-5", namespace="tracing-cell-03"})
                        ==
                        sum(sampler_build_info{cluster="prod-region-5", namespace="tracing-cell-03"})
                    )
                )
                and
                (
                    # All Deployment rollouts finished
                    sum(kube_deployment_status_replicas_updated{cluster="prod-region-5", namespace="tracing-cell-03"})
                    ==
                    sum(kube_deployment_spec_replicas{cluster="prod-region-5", namespace="tracing-cell-03"})
                )
                and
                (
                    # All StatefulSet rollouts finished
                    sum(kube_statefulset_status_replicas_updated{cluster="prod-region-5", namespace="tracing-cell-03"})
                    ==
                    sum(kube_statefulset_replicas{cluster="prod-region-5", namespace="tracing-cell-03"})
                )
                and
                (
                    # No unhealthy replicas in any Deployment
                    sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-5", namespace="tracing-cell-03"})
                    == 0
                )
                and
                (
                    # No unhealthy replicas in any StatefulSet
                    sum(kube_statefulset_status_replicas_current{cluster="prod-region-5", namespace="tracing-cell-03"})
                    ==
                    sum(kube_statefulset_status_replicas_ready {cluster="prod-region-5", namespace="tracing-cell-03"})
                )
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-5.tracing-cell-03 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    (
                        # All services have been updated to the expected version
                        sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-5", namespace="tracing-cell-03"})
                        ==
                        sum(tempo_build_info{cluster="prod-region-5", namespace="tracing-cell-03"})
                    )
                    and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                    (
                        # Adaptive Traces either hasn't been deployed
                        absent(sampler_build_info{cluster="prod-region-5", namespace="tracing-cell-03"})
                        or
                        # or sampler and sampler-gateway have been updated to the expected version
                        (
                            sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-5", namespace="tracing-cell-03"})
                            ==
                            sum(sampler_build_info{cluster="prod-region-5", namespace="tracing-cell-03"})
                        )
                    )
                    and
                    (
                        # All Deployment rollouts finished
                        sum(kube_deployment_status_replicas_updated{cluster="prod-region-5", namespace="tracing-cell-03"})
                        ==
                        sum(kube_deployment_spec_replicas{cluster="prod-region-5", namespace="tracing-cell-03"})
                    )
                    and
                    (
                        # All StatefulSet rollouts finished
                        sum(kube_statefulset_status_replicas_updated{cluster="prod-region-5", namespace="tracing-cell-03"})
                        ==
                        sum(kube_statefulset_replicas{cluster="prod-region-5", namespace="tracing-cell-03"})
                    )
                    and
                    (
                        # No unhealthy replicas in any Deployment
                        sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-5", namespace="tracing-cell-03"})
                        == 0
                    )
                    and
                    (
                        # No unhealthy replicas in any StatefulSet
                        sum(kube_statefulset_status_replicas_current{cluster="prod-region-5", namespace="tracing-cell-03"})
                        ==
                        sum(kube_statefulset_status_replicas_ready {cluster="prod-region-5", namespace="tracing-cell-03"})
                    )

                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `tempo-rollout-health-check` failed for `prod-region-5.tracing-cell-03`
              expression: steps["query-gate-prod-region-5--tracing-cell-03-tempo-rollout-health-check"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `tempo-rollout-health-check` passed for
                    `prod-region-5.tracing-cell-03`'
              expression: steps["query-gate-prod-region-5--tracing-cell-03-tempo-rollout-health-check"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-5--tracing-cell-03-tempo-rollout-health-check
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-2--tracing-cell-05-naive-check-weekly-release-number
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-2", namespace="tracing-cell-05"}
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-2.tracing-cell-05 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tracing-cell-05"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number` failed for `prod-region-2.tracing-cell-05`
              expression: steps["query-gate-prod-region-2--tracing-cell-05-naive-check-weekly-release-number"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number` passed
                    for `prod-region-2.tracing-cell-05`'
              expression: steps["query-gate-prod-region-2--tracing-cell-05-naive-check-weekly-release-number"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-2--tracing-cell-05-naive-check-weekly-release-number
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-2--tracing-cell-05-tempo-rollout-health-check
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: |
                (
                    # All services have been updated to the expected version
                    sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tracing-cell-05"})
                    ==
                    sum(tempo_build_info{cluster="prod-region-2", namespace="tracing-cell-05"})
                )
                and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                (
                    # Adaptive Traces either hasn't been deployed
                    absent(sampler_build_info{cluster="prod-region-2", namespace="tracing-cell-05"})
                    or
                    # or sampler and sampler-gateway have been updated to the expected version
                    (
                        sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tracing-cell-05"})
                        ==
                        sum(sampler_build_info{cluster="prod-region-2", namespace="tracing-cell-05"})
                    )
                )
                and
                (
                    # All Deployment rollouts finished
                    sum(kube_deployment_status_replicas_updated{cluster="prod-region-2", namespace="tracing-cell-05"})
                    ==
                    sum(kube_deployment_spec_replicas{cluster="prod-region-2", namespace="tracing-cell-05"})
                )
                and
                (
                    # All StatefulSet rollouts finished
                    sum(kube_statefulset_status_replicas_updated{cluster="prod-region-2", namespace="tracing-cell-05"})
                    ==
                    sum(kube_statefulset_replicas{cluster="prod-region-2", namespace="tracing-cell-05"})
                )
                and
                (
                    # No unhealthy replicas in any Deployment
                    sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-2", namespace="tracing-cell-05"})
                    == 0
                )
                and
                (
                    # No unhealthy replicas in any StatefulSet
                    sum(kube_statefulset_status_replicas_current{cluster="prod-region-2", namespace="tracing-cell-05"})
                    ==
                    sum(kube_statefulset_status_replicas_ready {cluster="prod-region-2", namespace="tracing-cell-05"})
                )
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-2.tracing-cell-05 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    (
                        # All services have been updated to the expected version
                        sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tracing-cell-05"})
                        ==
                        sum(tempo_build_info{cluster="prod-region-2", namespace="tracing-cell-05"})
                    )
                    and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                    (
                        # Adaptive Traces either hasn't been deployed
                        absent(sampler_build_info{cluster="prod-region-2", namespace="tracing-cell-05"})
                        or
                        # or sampler and sampler-gateway have been updated to the expected version
                        (
                            sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tracing-cell-05"})
                            ==
                            sum(sampler_build_info{cluster="prod-region-2", namespace="tracing-cell-05"})
                        )
                    )
                    and
                    (
                        # All Deployment rollouts finished
                        sum(kube_deployment_status_replicas_updated{cluster="prod-region-2", namespace="tracing-cell-05"})
                        ==
                        sum(kube_deployment_spec_replicas{cluster="prod-region-2", namespace="tracing-cell-05"})
                    )
                    and
                    (
                        # All StatefulSet rollouts finished
                        sum(kube_statefulset_status_replicas_updated{cluster="prod-region-2", namespace="tracing-cell-05"})
                        ==
                        sum(kube_statefulset_replicas{cluster="prod-region-2", namespace="tracing-cell-05"})
                    )
                    and
                    (
                        # No unhealthy replicas in any Deployment
                        sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-2", namespace="tracing-cell-05"})
                        == 0
                    )
                    and
                    (
                        # No unhealthy replicas in any StatefulSet
                        sum(kube_statefulset_status_replicas_current{cluster="prod-region-2", namespace="tracing-cell-05"})
                        ==
                        sum(kube_statefulset_status_replicas_ready {cluster="prod-region-2", namespace="tracing-cell-05"})
                    )

                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `tempo-rollout-health-check` failed for `prod-region-2.tracing-cell-05`
              expression: steps["query-gate-prod-region-2--tracing-cell-05-tempo-rollout-health-check"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `tempo-rollout-health-check` passed for
                    `prod-region-2.tracing-cell-05`'
              expression: steps["query-gate-prod-region-2--tracing-cell-05-tempo-rollout-health-check"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-2--tracing-cell-05-tempo-rollout-health-check
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-2", namespace="tempo-hsla-01"}
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-2.tempo-hsla-01 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tempo-hsla-01"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number` failed for `prod-region-2.tempo-hsla-01`
              expression: steps["query-gate-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number` passed
                    for `prod-region-2.tempo-hsla-01`'
              expression: steps["query-gate-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-2--tempo-hsla-01-naive-check-weekly-release-number
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-2--tempo-hsla-01-tempo-rollout-health-check
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: |
                (
                    # All services have been updated to the expected version
                    sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tempo-hsla-01"})
                    ==
                    sum(tempo_build_info{cluster="prod-region-2", namespace="tempo-hsla-01"})
                )
                and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                (
                    # Adaptive Traces either hasn't been deployed
                    absent(sampler_build_info{cluster="prod-region-2", namespace="tempo-hsla-01"})
                    or
                    # or sampler and sampler-gateway have been updated to the expected version
                    (
                        sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tempo-hsla-01"})
                        ==
                        sum(sampler_build_info{cluster="prod-region-2", namespace="tempo-hsla-01"})
                    )
                )
                and
                (
                    # All Deployment rollouts finished
                    sum(kube_deployment_status_replicas_updated{cluster="prod-region-2", namespace="tempo-hsla-01"})
                    ==
                    sum(kube_deployment_spec_replicas{cluster="prod-region-2", namespace="tempo-hsla-01"})
                )
                and
                (
                    # All StatefulSet rollouts finished
                    sum(kube_statefulset_status_replicas_updated{cluster="prod-region-2", namespace="tempo-hsla-01"})
                    ==
                    sum(kube_statefulset_replicas{cluster="prod-region-2", namespace="tempo-hsla-01"})
                )
                and
                (
                    # No unhealthy replicas in any Deployment
                    sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-2", namespace="tempo-hsla-01"})
                    == 0
                )
                and
                (
                    # No unhealthy replicas in any StatefulSet
                    sum(kube_statefulset_status_replicas_current{cluster="prod-region-2", namespace="tempo-hsla-01"})
                    ==
                    sum(kube_statefulset_status_replicas_ready {cluster="prod-region-2", namespace="tempo-hsla-01"})
                )
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-2.tempo-hsla-01 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    (
                        # All services have been updated to the expected version
                        sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tempo-hsla-01"})
                        ==
                        sum(tempo_build_info{cluster="prod-region-2", namespace="tempo-hsla-01"})
                    )
                    and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                    (
                        # Adaptive Traces either hasn't been deployed
                        absent(sampler_build_info{cluster="prod-region-2", namespace="tempo-hsla-01"})
                        or
                        # or sampler and sampler-gateway have been updated to the expected version
                        (
                            sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-2", namespace="tempo-hsla-01"})
                            ==
                            sum(sampler_build_info{cluster="prod-region-2", namespace="tempo-hsla-01"})
                        )
                    )
                    and
                    (
                        # All Deployment rollouts finished
                        sum(kube_deployment_status_replicas_updated{cluster="prod-region-2", namespace="tempo-hsla-01"})
                        ==
                        sum(kube_deployment_spec_replicas{cluster="prod-region-2", namespace="tempo-hsla-01"})
                    )
                    and
                    (
                        # All StatefulSet rollouts finished
                        sum(kube_statefulset_status_replicas_updated{cluster="prod-region-2", namespace="tempo-hsla-01"})
                        ==
                        sum(kube_statefulset_replicas{cluster="prod-region-2", namespace="tempo-hsla-01"})
                    )
                    and
                    (
                        # No unhealthy replicas in any Deployment
                        sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-2", namespace="tempo-hsla-01"})
                        == 0
                    )
                    and
                    (
                        # No unhealthy replicas in any StatefulSet
                        sum(kube_statefulset_status_replicas_current{cluster="prod-region-2", namespace="tempo-hsla-01"})
                        ==
                        sum(kube_statefulset_status_replicas_ready {cluster="prod-region-2", namespace="tempo-hsla-01"})
                    )

                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `tempo-rollout-health-check` failed for `prod-region-2.tempo-hsla-01`
              expression: steps["query-gate-prod-region-2--tempo-hsla-01-tempo-rollout-health-check"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `tempo-rollout-health-check` passed for
                    `prod-region-2.tempo-hsla-01`'
              expression: steps["query-gate-prod-region-2--tempo-hsla-01-tempo-rollout-health-check"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-2--tempo-hsla-01-tempo-rollout-health-check
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-eu-west-5", namespace="tempo-dedicated-08"}
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-eu-west-5.tempo-dedicated-08 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-eu-west-5", namespace="tempo-dedicated-08"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number` failed for `prod-eu-west-5.tempo-dedicated-08`
              expression: steps["query-gate-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number` passed
                    for `prod-eu-west-5.tempo-dedicated-08`'
              expression: steps["query-gate-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-eu-west-5--tempo-dedicated-08-naive-check-weekly-release-number
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-eu-west-5--tempo-dedicated-08-tempo-rollout-health-check
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: |
                (
                    # All services have been updated to the expected version
                    sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    ==
                    sum(tempo_build_info{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                )
                and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                (
                    # Adaptive Traces either hasn't been deployed
                    absent(sampler_build_info{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    or
                    # or sampler and sampler-gateway have been updated to the expected version
                    (
                        sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                        ==
                        sum(sampler_build_info{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    )
                )
                and
                (
                    # All Deployment rollouts finished
                    sum(kube_deployment_status_replicas_updated{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    ==
                    sum(kube_deployment_spec_replicas{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                )
                and
                (
                    # All StatefulSet rollouts finished
                    sum(kube_statefulset_status_replicas_updated{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    ==
                    sum(kube_statefulset_replicas{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                )
                and
                (
                    # No unhealthy replicas in any Deployment
                    sum(kube_deployment_status_replicas_unavailable{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    == 0
                )
                and
                (
                    # No unhealthy replicas in any StatefulSet
                    sum(kube_statefulset_status_replicas_current{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    ==
                    sum(kube_statefulset_status_replicas_ready {cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                )
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-eu-west-5.tempo-dedicated-08 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    (
                        # All services have been updated to the expected version
                        sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                        ==
                        sum(tempo_build_info{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    )
                    and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                    (
                        # Adaptive Traces either hasn't been deployed
                        absent(sampler_build_info{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                        or
                        # or sampler and sampler-gateway have been updated to the expected version
                        (
                            sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                            ==
                            sum(sampler_build_info{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                        )
                    )
                    and
                    (
                        # All Deployment rollouts finished
                        sum(kube_deployment_status_replicas_updated{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                        ==
                        sum(kube_deployment_spec_replicas{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    )
                    and
                    (
                        # All StatefulSet rollouts finished
                        sum(kube_statefulset_status_replicas_updated{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                        ==
                        sum(kube_statefulset_replicas{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    )
                    and
                    (
                        # No unhealthy replicas in any Deployment
                        sum(kube_deployment_status_replicas_unavailable{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                        == 0
                    )
                    and
                    (
                        # No unhealthy replicas in any StatefulSet
                        sum(kube_statefulset_status_replicas_current{cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                        ==
                        sum(kube_statefulset_status_replicas_ready {cluster="prod-eu-west-5", namespace="tempo-dedicated-08"})
                    )

                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `tempo-rollout-health-check` failed for `prod-eu-west-5.tempo-dedicated-08`
              expression: steps["query-gate-prod-eu-west-5--tempo-dedicated-08-tempo-rollout-health-check"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `tempo-rollout-health-check` passed for
                    `prod-eu-west-5.tempo-dedicated-08`'
              expression: steps["query-gate-prod-eu-west-5--tempo-dedicated-08-tempo-rollout-health-check"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-eu-west-5--tempo-dedicated-08-tempo-rollout-health-check
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-1--tracing-cell-06-naive-check-weekly-release-number
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-1", namespace="tracing-cell-06"}
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-1.tracing-cell-06 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-1", namespace="tracing-cell-06"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number` failed for `prod-region-1.tracing-cell-06`
              expression: steps["query-gate-prod-region-1--tracing-cell-06-naive-check-weekly-release-number"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number` passed
                    for `prod-region-1.tracing-cell-06`'
              expression: steps["query-gate-prod-region-1--tracing-cell-06-naive-check-weekly-release-number"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-1--tracing-cell-06-naive-check-weekly-release-number
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-1--tracing-cell-06-tempo-rollout-health-check
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: |
                (
                    # All services have been updated to the expected version
                    sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-1", namespace="tracing-cell-06"})
                    ==
                    sum(tempo_build_info{cluster="prod-region-1", namespace="tracing-cell-06"})
                )
                and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                (
                    # Adaptive Traces either hasn't been deployed
                    absent(sampler_build_info{cluster="prod-region-1", namespace="tracing-cell-06"})
                    or
                    # or sampler and sampler-gateway have been updated to the expected version
                    (
                        sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-1", namespace="tracing-cell-06"})
                        ==
                        sum(sampler_build_info{cluster="prod-region-1", namespace="tracing-cell-06"})
                    )
                )
                and
                (
                    # All Deployment rollouts finished
                    sum(kube_deployment_status_replicas_updated{cluster="prod-region-1", namespace="tracing-cell-06"})
                    ==
                    sum(kube_deployment_spec_replicas{cluster="prod-region-1", namespace="tracing-cell-06"})
                )
                and
                (
                    # All StatefulSet rollouts finished
                    sum(kube_statefulset_status_replicas_updated{cluster="prod-region-1", namespace="tracing-cell-06"})
                    ==
                    sum(kube_statefulset_replicas{cluster="prod-region-1", namespace="tracing-cell-06"})
                )
                and
                (
                    # No unhealthy replicas in any Deployment
                    sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-1", namespace="tracing-cell-06"})
                    == 0
                )
                and
                (
                    # No unhealthy replicas in any StatefulSet
                    sum(kube_statefulset_status_replicas_current{cluster="prod-region-1", namespace="tracing-cell-06"})
                    ==
                    sum(kube_statefulset_status_replicas_ready {cluster="prod-region-1", namespace="tracing-cell-06"})
                )
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-1.tracing-cell-06 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    (
                        # All services have been updated to the expected version
                        sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-1", namespace="tracing-cell-06"})
                        ==
                        sum(tempo_build_info{cluster="prod-region-1", namespace="tracing-cell-06"})
                    )
                    and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                    (
                        # Adaptive Traces either hasn't been deployed
                        absent(sampler_build_info{cluster="prod-region-1", namespace="tracing-cell-06"})
                        or
                        # or sampler and sampler-gateway have been updated to the expected version
                        (
                            sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-1", namespace="tracing-cell-06"})
                            ==
                            sum(sampler_build_info{cluster="prod-region-1", namespace="tracing-cell-06"})
                        )
                    )
                    and
                    (
                        # All Deployment rollouts finished
                        sum(kube_deployment_status_replicas_updated{cluster="prod-region-1", namespace="tracing-cell-06"})
                        ==
                        sum(kube_deployment_spec_replicas{cluster="prod-region-1", namespace="tracing-cell-06"})
                    )
                    and
                    (
                        # All StatefulSet rollouts finished
                        sum(kube_statefulset_status_replicas_updated{cluster="prod-region-1", namespace="tracing-cell-06"})
                        ==
                        sum(kube_statefulset_replicas{cluster="prod-region-1", namespace="tracing-cell-06"})
                    )
                    and
                    (
                        # No unhealthy replicas in any Deployment
                        sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-1", namespace="tracing-cell-06"})
                        == 0
                    )
                    and
                    (
                        # No unhealthy replicas in any StatefulSet
                        sum(kube_statefulset_status_replicas_current{cluster="prod-region-1", namespace="tracing-cell-06"})
                        ==
                        sum(kube_statefulset_status_replicas_ready {cluster="prod-region-1", namespace="tracing-cell-06"})
                    )

                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `tempo-rollout-health-check` failed for `prod-region-1.tracing-cell-06`
              expression: steps["query-gate-prod-region-1--tracing-cell-06-tempo-rollout-health-check"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `tempo-rollout-health-check` passed for
                    `prod-region-1.tracing-cell-06`'
              expression: steps["query-gate-prod-region-1--tracing-cell-06-tempo-rollout-health-check"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-1--tracing-cell-06-tempo-rollout-health-check
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-3", namespace="tempo-dedicated-01"}
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-3.tempo-dedicated-01 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-3", namespace="tempo-dedicated-01"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number` failed for `prod-region-3.tempo-dedicated-01`
              expression: steps["query-gate-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number` passed
                    for `prod-region-3.tempo-dedicated-01`'
              expression: steps["query-gate-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-3--tempo-dedicated-01-naive-check-weekly-release-number
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-3--tempo-dedicated-01-tempo-rollout-health-check
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: |
                (
                    # All services have been updated to the expected version
                    sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    ==
                    sum(tempo_build_info{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                )
                and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                (
                    # Adaptive Traces either hasn't been deployed
                    absent(sampler_build_info{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    or
                    # or sampler and sampler-gateway have been updated to the expected version
                    (
                        sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-3", namespace="tempo-dedicated-01"})
                        ==
                        sum(sampler_build_info{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    )
                )
                and
                (
                    # All Deployment rollouts finished
                    sum(kube_deployment_status_replicas_updated{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    ==
                    sum(kube_deployment_spec_replicas{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                )
                and
                (
                    # All StatefulSet rollouts finished
                    sum(kube_statefulset_status_replicas_updated{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    ==
                    sum(kube_statefulset_replicas{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                )
                and
                (
                    # No unhealthy replicas in any Deployment
                    sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    == 0
                )
                and
                (
                    # No unhealthy replicas in any StatefulSet
                    sum(kube_statefulset_status_replicas_current{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    ==
                    sum(kube_statefulset_status_replicas_ready {cluster="prod-region-3", namespace="tempo-dedicated-01"})
                )
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-3.tempo-dedicated-01 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    (
                        # All services have been updated to the expected version
                        sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-3", namespace="tempo-dedicated-01"})
                        ==
                        sum(tempo_build_info{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    )
                    and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                    (
                        # Adaptive Traces either hasn't been deployed
                        absent(sampler_build_info{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                        or
                        # or sampler and sampler-gateway have been updated to the expected version
                        (
                            sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-3", namespace="tempo-dedicated-01"})
                            ==
                            sum(sampler_build_info{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                        )
                    )
                    and
                    (
                        # All Deployment rollouts finished
                        sum(kube_deployment_status_replicas_updated{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                        ==
                        sum(kube_deployment_spec_replicas{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    )
                    and
                    (
                        # All StatefulSet rollouts finished
                        sum(kube_statefulset_status_replicas_updated{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                        ==
                        sum(kube_statefulset_replicas{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    )
                    and
                    (
                        # No unhealthy replicas in any Deployment
                        sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                        == 0
                    )
                    and
                    (
                        # No unhealthy replicas in any StatefulSet
                        sum(kube_statefulset_status_replicas_current{cluster="prod-region-3", namespace="tempo-dedicated-01"})
                        ==
                        sum(kube_statefulset_status_replicas_ready {cluster="prod-region-3", namespace="tempo-dedicated-01"})
                    )

                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `tempo-rollout-health-check` failed for `prod-region-3.tempo-dedicated-01`
              expression: steps["query-gate-prod-region-3--tempo-dedicated-01-tempo-rollout-health-check"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `tempo-rollout-health-check` passed for
                    `prod-region-3.tempo-dedicated-01`'
              expression: steps["query-gate-prod-region-3--tempo-dedicated-01-tempo-rollout-health-check"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-3--tempo-dedicated-01-tempo-rollout-health-check
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*",
                cluster="prod-region-6", namespace="tempo-dedicated-04"}
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-6.tempo-dedicated-04 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-6", namespace="tempo-dedicated-04"}
                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `naive-check-weekly-release-number` failed for `prod-region-6.tempo-dedicated-04`
              expression: steps["query-gate-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `naive-check-weekly-release-number` passed
                    for `prod-region-6.tempo-dedicated-04`'
              expression: steps["query-gate-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-6--tempo-dedicated-04-naive-check-weekly-release-number
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - inputs:
        parameters:
        - name: releaseNumberProd
        - name: mergedAt
      name: success-query-prod-region-6--tempo-dedicated-04-tempo-rollout-health-check
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: cortex_cluster
              value: ops
            - name: initial_delay
              value: 10m
            - name: query
              value: |
                (
                    # All services have been updated to the expected version
                    sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    ==
                    sum(tempo_build_info{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                )
                and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                (
                    # Adaptive Traces either hasn't been deployed
                    absent(sampler_build_info{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    or
                    # or sampler and sampler-gateway have been updated to the expected version
                    (
                        sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-6", namespace="tempo-dedicated-04"})
                        ==
                        sum(sampler_build_info{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    )
                )
                and
                (
                    # All Deployment rollouts finished
                    sum(kube_deployment_status_replicas_updated{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    ==
                    sum(kube_deployment_spec_replicas{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                )
                and
                (
                    # All StatefulSet rollouts finished
                    sum(kube_statefulset_status_replicas_updated{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    ==
                    sum(kube_statefulset_replicas{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                )
                and
                (
                    # No unhealthy replicas in any Deployment
                    sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    == 0
                )
                and
                (
                    # No unhealthy replicas in any StatefulSet
                    sum(kube_statefulset_status_replicas_current{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    ==
                    sum(kube_statefulset_status_replicas_ready {cluster="prod-region-6", namespace="tempo-dedicated-04"})
                )
            - name: retry_count
              value: 120
            - name: retry_delay
              value: 2m
            - name: store_results
              value: false
          hooks:
            query-fail:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @oncall-team The query for cell prod-region-6.tempo-dedicated-04 failed.

                    Once the issue is fixed, you can resume the rollout by going to <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> and clicking Retry.

                    Query:
                    ```
                    (
                        # All services have been updated to the expected version
                        sum(tempo_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-6", namespace="tempo-dedicated-04"})
                        ==
                        sum(tempo_build_info{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    )
                    and ignoring(namespace, cluster) # we have to ignore namespace and cluster b/c the absent query below inserts those labels. once we remove "absent" we can remove this as well
                    (
                        # Adaptive Traces either hasn't been deployed
                        absent(sampler_build_info{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                        or
                        # or sampler and sampler-gateway have been updated to the expected version
                        (
                            sum(sampler_build_info{version=~"weekly-{{inputs.parameters.releaseNumberProd}}-.*", cluster="prod-region-6", namespace="tempo-dedicated-04"})
                            ==
                            sum(sampler_build_info{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                        )
                    )
                    and
                    (
                        # All Deployment rollouts finished
                        sum(kube_deployment_status_replicas_updated{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                        ==
                        sum(kube_deployment_spec_replicas{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    )
                    and
                    (
                        # All StatefulSet rollouts finished
                        sum(kube_statefulset_status_replicas_updated{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                        ==
                        sum(kube_statefulset_replicas{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    )
                    and
                    (
                        # No unhealthy replicas in any Deployment
                        sum(kube_deployment_status_replicas_unavailable{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                        == 0
                    )
                    and
                    (
                        # No unhealthy replicas in any StatefulSet
                        sum(kube_statefulset_status_replicas_current{cluster="prod-region-6", namespace="tempo-dedicated-04"})
                        ==
                        sum(kube_statefulset_status_replicas_ready {cluster="prod-region-6", namespace="tempo-dedicated-04"})
                    )

                    ```
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Query `tempo-rollout-health-check` failed for `prod-region-6.tempo-dedicated-04`
              expression: steps["query-gate-prod-region-6--tempo-dedicated-04-tempo-rollout-health-check"].status
                == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
            query-pass:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: ':prometheus: Query `tempo-rollout-health-check` passed for
                    `prod-region-6.tempo-dedicated-04`'
              expression: steps["query-gate-prod-region-6--tempo-dedicated-04-tempo-rollout-health-check"].status
                == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: query-gate-prod-region-6--tempo-dedicated-04-tempo-rollout-health-check
          templateRef:
            clusterScope: true
            name: query-metrics
            template: query-metrics
    - dag:
        tasks:
        - arguments:
            parameters:
            - name: channel
              value: '#automated-rollouts'
            - name: color
              value: '#ffff00'
            - name: context
              value: ""
            - name: message
              value: |
                @oncall-team The following cells are ready to be rolled out:

                   prod-region-6.tempo-dedicated-04 (prod, {{inputs.parameters.releaseNumberProd}})
                   prod-region-3.tempo-dedicated-01 (prod, {{inputs.parameters.releaseNumberProd}})
                   prod-region-1.tracing-cell-06 (prod, {{inputs.parameters.releaseNumberProd}})
                   prod-eu-west-5.tempo-dedicated-08 (prod, {{inputs.parameters.releaseNumberProd}})
                   prod-region-2.tempo-hsla-01 (prod, {{inputs.parameters.releaseNumberProd}})
                   prod-region-2.tracing-cell-05 (prod, {{inputs.parameters.releaseNumberProd}})
                   prod-region-5.tracing-cell-03 (prod, {{inputs.parameters.releaseNumberProd}})
                   prod-region-4.tracing-prod-27 (prod, {{inputs.parameters.releaseNumberProd}})

                Visit <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|the workflow> to approve (by clicking on the Resume button).
            - name: thread_send_also_to_channel
              value: "true"
            - name: thread_ts
              value: '{{workflow.outputs.parameters.thread_ts}}'
            - name: title
              value: Waiting for approval to rollout
          name: wait-for-approval-notify
          templateRef:
            clusterScope: true
            name: slack-notify
            template: slack-notify
        - hooks:
            workflow-approved:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#00ff00'
                - name: context
                  value: ""
                - name: message
                  value: ""
                - name: thread_send_also_to_channel
                  value: "false"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Approval submitted
              expression: tasks["wait-for-approval"].status == "Succeeded"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: wait-for-approval
          templateRef:
            clusterScope: true
            name: approve-without-deadline
            template: approve-without-deadline
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          depends: wait-for-approval && wait-for-approval-notify
          name: release-prod-region-6--tempo-dedicated-04
          template: release-prod-region-6--tempo-dedicated-04
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: mergedAt
              value: '{{tasks.release-prod-region-6--tempo-dedicated-04.outputs.parameters.mergedAt}}'
          depends: release-prod-region-6--tempo-dedicated-04
          name: healthchecks-prod-region-6--tempo-dedicated-04
          template: healthchecks-prod-region-6--tempo-dedicated-04
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          depends: healthchecks-prod-region-6--tempo-dedicated-04
          name: release-prod-region-3--tempo-dedicated-01
          template: release-prod-region-3--tempo-dedicated-01
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: mergedAt
              value: '{{tasks.release-prod-region-3--tempo-dedicated-01.outputs.parameters.mergedAt}}'
          depends: release-prod-region-3--tempo-dedicated-01
          name: healthchecks-prod-region-3--tempo-dedicated-01
          template: healthchecks-prod-region-3--tempo-dedicated-01
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          depends: healthchecks-prod-region-3--tempo-dedicated-01
          name: release-prod-region-1--tracing-cell-06
          template: release-prod-region-1--tracing-cell-06
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: mergedAt
              value: '{{tasks.release-prod-region-1--tracing-cell-06.outputs.parameters.mergedAt}}'
          depends: release-prod-region-1--tracing-cell-06
          name: healthchecks-prod-region-1--tracing-cell-06
          template: healthchecks-prod-region-1--tracing-cell-06
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          depends: healthchecks-prod-region-1--tracing-cell-06
          name: release-prod-eu-west-5--tempo-dedicated-08
          template: release-prod-eu-west-5--tempo-dedicated-08
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: mergedAt
              value: '{{tasks.release-prod-eu-west-5--tempo-dedicated-08.outputs.parameters.mergedAt}}'
          depends: release-prod-eu-west-5--tempo-dedicated-08
          name: healthchecks-prod-eu-west-5--tempo-dedicated-08
          template: healthchecks-prod-eu-west-5--tempo-dedicated-08
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          depends: healthchecks-prod-eu-west-5--tempo-dedicated-08
          name: release-prod-region-2--tempo-hsla-01
          template: release-prod-region-2--tempo-hsla-01
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: mergedAt
              value: '{{tasks.release-prod-region-2--tempo-hsla-01.outputs.parameters.mergedAt}}'
          depends: release-prod-region-2--tempo-hsla-01
          name: healthchecks-prod-region-2--tempo-hsla-01
          template: healthchecks-prod-region-2--tempo-hsla-01
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          depends: healthchecks-prod-region-2--tempo-hsla-01
          name: release-prod-region-2--tracing-cell-05
          template: release-prod-region-2--tracing-cell-05
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: mergedAt
              value: '{{tasks.release-prod-region-2--tracing-cell-05.outputs.parameters.mergedAt}}'
          depends: release-prod-region-2--tracing-cell-05
          name: healthchecks-prod-region-2--tracing-cell-05
          template: healthchecks-prod-region-2--tracing-cell-05
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          depends: healthchecks-prod-region-2--tracing-cell-05
          name: release-prod-region-5--tracing-cell-03
          template: release-prod-region-5--tracing-cell-03
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: mergedAt
              value: '{{tasks.release-prod-region-5--tracing-cell-03.outputs.parameters.mergedAt}}'
          depends: release-prod-region-5--tracing-cell-03
          name: healthchecks-prod-region-5--tracing-cell-03
          template: healthchecks-prod-region-5--tracing-cell-03
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
          depends: healthchecks-prod-region-5--tracing-cell-03
          name: release-prod-region-4--tracing-prod-27
          template: release-prod-region-4--tracing-prod-27
        - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: mergedAt
              value: '{{tasks.release-prod-region-4--tracing-prod-27.outputs.parameters.mergedAt}}'
          depends: release-prod-region-4--tracing-prod-27
          name: healthchecks-prod-region-4--tracing-prod-27
          template: healthchecks-prod-region-4--tracing-prod-27
      inputs:
        parameters:
        - name: releaseNumberProd
      name: do-release-tempo
      serviceAccountName: argo-workflow
    - name: main
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: channel
              value: '#automated-rollouts'
            - name: color
              value: '#00ff00'
            - name: context
              value: <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|Workflow>
            - name: message
              value: ""
            - name: title
              value: Rollout started for `{{ workflow.name }}`
          name: init-message
          templateRef:
            clusterScope: true
            name: slack-notify
            template: slack-notify
      - - arguments:
            parameters:
            - name: firstMonday
              value: "2021-07-19"
            - name: lag
              value: 1
            - name: releasePrefix
              value: r
          name: calculate-release-num-prod
          templateRef:
            clusterScope: true
            name: calculate-release-number
            template: calculate-release-number
      - - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{steps.calculate-release-num-prod.outputs.parameters.releaseNumber}}'
          name: make-release
          template: check-for-file-make-release
      - - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{steps.calculate-release-num-prod.outputs.parameters.releaseNumber}}'
          name: run-release
          template: release
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: check-for-file-make-release
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: file-path
              value: ksonnet/lib/tempo/releases/{{inputs.parameters.releaseNumberProd}}/tempo.libsonnet
            - name: repo-name
              value: infra_deployments
            - name: repo-owner
              value: grafana
          hooks:
            check-for-file-failed:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: |-
                    @tempo-secondary-oncall Checking for the file `ksonnet/lib/tempo/releases/{{inputs.parameters.releaseNumberProd}}/tempo.libsonnet` failed. It looks like the release was not
                    created. Please investigate the failure and use the `Retry` button on
                    the <https://ktwm-uckvrmkuw.yprbtch.uvj/hxcndyuwd/{{workflow.namespace}}/{{workflow.name}}|workflow> once the problem is resolved and the release is in
                    place.

                    Note that the release is created on a Monday morning when rolling out
                    the dev cells. That job probably failed earlier in the week. Make sure
                    to <https://ofwj-abkzbjlln.ehqnsvz.fff/ctmt-vhpsehoui/oivaz-oj/vrfco-lsjunw-iojgmpdhms-lsjwja-vmi|submit a successful run there first>, so the release is created and
                    this one can succeed.
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: Release not created
              expression: steps["check-for-file"].status == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: check-for-file
          templateRef:
            clusterScope: true
            name: check-for-file
            template: check-for-file
    - container:
        args:
        - |
          #!/usr/bin/env sh

          set -eux

          CURRENT_WEEK=$(date +%Y%W)

          # If current week is in the list of weeks to skip, then skip
          for skip_week_monday in $(echo "${SKIP_WEEK_MONDAYS}" | tr ',' ' '); do
              skip_week=$(date -d "${skip_week_monday}" +%Y%W)
              if [ "${CURRENT_WEEK}" = "${skip_week}" ]; then
                  if [ "${DRYRUN:-}" != "1" ]; then
                      echo "Skip"
                      exit 0
                  fi
              fi
          done

          echo "DontSkip"
        command:
        - /bin/sh
        - -c
        env:
        - name: SKIP_WEEK_MONDAYS
          value: '{{inputs.parameters.skipWeekMondaysCommaSeparated}}'
        - name: DRYRUN
          value: '{{= inputs.parameters.dryRun == "true" ? 1 : 0}}'
        image: alpine:3.18
        resources:
          requests:
            cpu: 10m
            memory: 50Mi
      inputs:
        parameters:
        - name: skipWeekMondaysCommaSeparated
        - default: false
          name: dryRun
      metadata:
        labels:
          template-name: maybe-skip-week
      name: maybe-skip-week
      serviceAccountName: argo-workflow
    - container:
        args:
        - |
          import argparse
          from datetime import date


          def calc_new_release_number(today, scheduled_release_num, first_monday, skip_week_mondays):
              prefix = scheduled_release_num[0]
              release_num = int(scheduled_release_num[1:])
              # Calculate number of weeks between "first-monday" and "skip-week-monday"; these are the release numbers we skip.
              skipped_release_nums = [
                  ((skip_week_monday - first_monday).days // 7) + 1
                  for skip_week_monday in skip_week_mondays
              ]

              # Calculate the number of skipped weeks between the intended release and today
              # This is the offset we need to apply to the release number.
              # Ex: We're intending to release r317 but we skipped r318, and this week is r319
              # That means that there was a skipped week between now and the release, so we need to offset by 1.

              skipped_weeks = 0
              todays_release_num = ((today - first_monday).days // 7) + 1
              for skipped_release_num in skipped_release_nums:
                  if release_num <= skipped_release_num <= todays_release_num:
                      skipped_weeks += 1

              release_num -= skipped_weeks

              # Do not use any of the skipped release numbers
              while release_num in skipped_release_nums:
                  release_num -= 1

              return f'{prefix}%d' % release_num


          if __name__ == '__main__':
              parser = argparse.ArgumentParser()
              parser.add_argument('--first-monday', dest='first_monday',
                                  help='Monday of the week of the first release. Format "YYYY-MM-DD".')
              parser.add_argument('--skip-week-mondays', dest='skip_week_mondays',
                                  help='Comma-separated list of weeks to skip. Format: Date of the week \'s monday "YYYY-MM-DD"')
              parser.add_argument('--release-number', dest='release_num',
                                  help='Current release number.')
              parser.add_argument('--output-file', dest='output_file', type=argparse.FileType('w'),
                                  help='Output file that will contain the offset release number.')
              parser.add_argument('--dry-run', dest='dry_run', default=False, action=argparse.BooleanOptionalAction,
                                  help='Dry-run mode. Will print the results of calculating the offset release, but keeps the output release number as is.')
              args = parser.parse_args()

              release_num = calc_new_release_number(
                  today=date.today(),
                  scheduled_release_num=args.release_num,
                  first_monday=date.fromisoformat(args.first_monday),
                  skip_week_mondays=[
                      date.fromisoformat(d) for d in args.skip_week_mondays.split(',')
                  ]

              )

              print(f'New release number {args.release_num} -> {release_num}')

              if args.dry_run:
                  release_num = args.release_num
                  print(f'Dry-run is set. Falling back to release number {release_num}')

              with args.output_file as f:
                  f.write(release_num + '\n')
        - --skip-week-mondays
        - '{{inputs.parameters.skipWeekMondaysCommaSeparated}}'
        - --first-monday
        - '{{inputs.parameters.firstMonday}}'
        - --release-number
        - '{{inputs.parameters.releaseNumber}}'
        - --output-file
        - '{{inputs.parameters.outputFile}}'
        - '{{= inputs.parameters.dryRun == "true" ? "--dry-run" : "--no-dry-run"}}'
        command:
        - python3
        - -c
        image: python:3
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        volumeMounts:
        - mountPath: /offset-release-number
          name: outputs
      inputs:
        parameters:
        - name: skipWeekMondaysCommaSeparated
        - name: firstMonday
        - name: releaseNumber
        - default: /offset-release-number/release-number
          name: outputFile
        - default: false
          name: dryRun
      metadata:
        labels:
          template-name: offset-release-number
      name: offset-release-number
      outputs:
        parameters:
        - name: releaseNumber
          valueFrom:
            default: ""
            path: '{{inputs.parameters.outputFile}}'
      serviceAccountName: argo-workflow
      volumes:
      - emptyDir: {}
        name: outputs
    - inputs:
        parameters:
        - name: releaseNumberProd
      name: release
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: dryRun
              value: false
            - name: skipWeekMondaysCommaSeparated
              value: 2025-12-22,2025-12-29
          name: maybe-skip-release-week
          template: maybe-skip-week
      - - arguments:
            parameters:
            - name: dryRun
              value: false
            - name: firstMonday
              value: "2021-07-19"
            - name: releaseNumber
              value: '{{inputs.parameters.releaseNumberProd}}'
            - name: skipWeekMondaysCommaSeparated
              value: 2025-12-22,2025-12-29
          name: offset-release-number-prod
          template: offset-release-number
      - - arguments:
            parameters:
            - name: releaseNumberProd
              value: '{{steps.offset-release-number-prod.outputs.parameters.releaseNumber}}'
          name: do-release
          template: do-release-tempo
          when: '{{steps.maybe-skip-release-week.outputs.result}} != Skip'
      - - arguments:
            parameters:
            - name: channel
              value: '#automated-rollouts'
            - name: color
              value: '#00ff00'
            - name: context
              value: ""
            - name: message
              value: Release for tempo prod wave is being skipped.
            - name: thread_send_also_to_channel
              value: "false"
            - name: thread_ts
              value: '{{workflow.outputs.parameters.thread_ts}}'
            - name: title
              value: Skipping release
          name: notify-skip-release-tempo-prod
          templateRef:
            clusterScope: true
            name: slack-notify
            template: slack-notify
          when: '{{steps.maybe-skip-release-week.outputs.result}} == Skip'
    - inputs:
        parameters:
        - name: owner
        - name: repo
        - name: commit
      name: wait-for-ci-notify
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: owner
              value: '{{ inputs.parameters.owner }}'
            - name: ref
              value: '{{ inputs.parameters.commit }}'
            - name: repo
              value: '{{ inputs.parameters.repo }}'
            - name: timeout
              value: 24h
          hooks:
            ci-failed:
              arguments:
                parameters:
                - name: channel
                  value: '#automated-rollouts'
                - name: color
                  value: '#ff0000'
                - name: context
                  value: ""
                - name: message
                  value: '@oncall-team CI failed for commit {{ inputs.parameters.commit
                    }}. Please check <https://asvyxb.txp/{{ inputs.parameters.owner
                    }}/{{ inputs.parameters.repo }}/commit/{{ inputs.parameters.commit
                    }}|the logs>. Once the problem is resolved, visit the workflow
                    link and retry.'
                - name: thread_send_also_to_channel
                  value: "true"
                - name: thread_ts
                  value: '{{workflow.outputs.parameters.thread_ts}}'
                - name: title
                  value: CI failed
              expression: steps["wait-for-ci"].status == "Failed"
              templateRef:
                clusterScope: true
                name: slack-notify
                template: slack-notify
          name: wait-for-ci
          templateRef:
            clusterScope: true
            name: wait-for-github-ci
            template: wait-for-github-ci
    - name: exit-handler
      serviceAccountName: argo-workflow
      steps:
      - - arguments:
            parameters:
            - name: channel
              value: '#automated-rollouts'
            - name: color
              value: '#ff0000'
            - name: context
              value: ""
            - name: message
              value: ""
            - name: thread_send_also_to_channel
              value: "true"
            - name: thread_ts
              value: '{{workflow.outputs.parameters.thread_ts}}'
            - name: title
              value: '@oncall-team Workflow `{{workflow.namespace}}/{{workflow.name}}`
                did not finish successfully'
          name: exit-handler-failure
          templateRef:
            clusterScope: true
            name: slack-notify
            template: slack-notify
          when: '{{workflow.status}} != Succeeded && {{= sprig.contains("Stopped with
            strategy ''Stop''", workflow.failures) }} == false && {{= sprig.contains("Step
            exceeded its deadline", workflow.failures) }} == false'
    ttlStrategy:
      secondsAfterCompletion: 604800
